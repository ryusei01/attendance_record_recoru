# 修正履歴と使用 AI 技術の詳細

## 目次

1. [使用している AI 技術の詳細](#使用しているai技術の詳細)
2. [これまでの修正内容](#これまでの修正内容)
3. [技術スタック](#技術スタック)
4. [実装の特徴](#実装の特徴)

---

## 使用している AI 技術の詳細

### 1. EasyOCR（推奨・デフォルト）

#### 技術概要

- **種類**: ディープラーニングベースの OCR エンジン
- **開発元**: JaidedAI
- **ライセンス**: Apache License 2.0（無料・商用利用可）
- **公式リポジトリ**: https://github.com/JaidedAI/EasyOCR

#### 技術的詳細

- **対応言語**: 80 以上の言語（日本語・英語を含む）
- **モデルアーキテクチャ**:
  - 事前学習済みのニューラルネットワークモデルを使用
  - CRAFT（Character Region Awareness for Text）によるテキスト検出
  - CRNN（Convolutional Recurrent Neural Network）による文字認識
- **実行環境**:
  - GPU/CPU 両方で動作可能
  - 本プロジェクトでは CPU モードで実行（`gpu=False`）
  - GPU 使用時は認識速度が大幅に向上
- **特徴**:
  - 手書き文字や複雑なレイアウトにも対応
  - 日本語の認識精度が高い
  - 表形式の読み取りにも対応
  - 文字の位置情報（バウンディングボックス）も取得可能

#### 実装詳細

```python
# src/ocr_extractor.py での実装
self.reader = easyocr.Reader(['ja', 'en'], gpu=False)
results = self.reader.readtext(image_path)
text = '\n'.join([result[1] for result in results])
```

- **初期化**: 日本語（'ja'）と英語（'en'）の 2 言語を指定
- **エラーハンドリング**: 初期化失敗時は Tesseract OCR に自動フォールバック
- **使用箇所**: `src/ocr_extractor.py`の`extract_text()`メソッド

---

### 2. Tesseract OCR（フォールバック）

#### 技術概要

- **種類**: オープンソースの OCR エンジン
- **開発元**: Google（現在はコミュニティ主導）
- **ライセンス**: Apache License 2.0（無料・商用利用可）
- **公式リポジトリ**: https://github.com/tesseract-ocr/tesseract

#### 技術的詳細

- **対応言語**: 100 以上の言語
- **モデルアーキテクチャ**:
  - 伝統的な OCR 技術と機械学習を組み合わせたアプローチ
  - LSTM（Long Short-Term Memory）ベースの文字認識
- **特徴**:
  - 長年の開発実績がある安定した OCR エンジン
  - 軽量で高速
  - システムリソースの使用量が少ない
  - 画像前処理（ノイズ除去、コントラスト調整）と組み合わせて使用

#### 実装詳細

```python
# src/ocr_extractor.py での実装
processed_img = self.preprocess_image(image_path)
text = pytesseract.image_to_string(processed_img, lang='jpn+eng')
```

- **使用条件**: EasyOCR の初期化に失敗した場合、または明示的に`use_easyocr=False`を指定した場合
- **前処理**: OpenCV を使用した画像前処理を経てから OCR を実行
- **言語設定**: 日本語（'jpn'）と英語（'eng'）を指定

---

### 3. OpenCV（画像前処理）

#### 技術概要

- **種類**: オープンソースのコンピュータビジョンライブラリ
- **開発元**: OpenCV Foundation
- **ライセンス**: Apache License 2.0（無料・商用利用可）
- **公式サイト**: https://opencv.org/

#### 実装されている前処理機能

1. **傾き補正（Deskew）**

   - Hough 変換を使用した傾き角度の検出
   - 画像の回転による補正
   - 実装: `detect_skew_angle()`, `deskew_image()`メソッド

2. **ノイズ除去**

   - `cv2.fastNlMeansDenoising()`を使用した非局所平均法によるノイズ除去
   - 実装: `preprocess_image()`メソッド

3. **コントラスト調整**

   - CLAHE（Contrast Limited Adaptive Histogram Equalization）による適応的ヒストグラム均等化
   - 実装: `preprocess_image()`メソッド

4. **二値化処理**
   - Otsu 法による自動閾値決定
   - 実装: `preprocess_image()`メソッド

#### 前処理の効果

- OCR の認識精度を向上させる
- 特に手書き文字や低品質な画像に対して効果的
- 傾いた画像の補正により、テキストの読み取り精度が向上

---

## これまでの修正内容

### フェーズ 1: 基本機能の実装

#### 1. OCR 抽出機能の実装（`src/ocr_extractor.py`）

**実装内容**:

- EasyOCR と Tesseract OCR の両方に対応
- 画像前処理機能の実装（傾き補正、ノイズ除去、コントラスト調整、二値化）
- JPEG、PNG、PDF 形式に対応
- 日付、出勤時刻、退勤時刻、休憩時間の抽出機能

**主な機能**:

- `extract_from_image()`: 画像ファイルからの勤怠データ抽出
- `extract_from_pdf()`: PDF ファイルからの勤怠データ抽出（各ページを画像に変換して処理）
- `parse_attendance_data()`: 抽出テキストから勤怠データをパース
- `preprocess_image()`: 画像前処理による認識精度向上
- `deskew_image()`: 画像の傾き補正

**修正ポイント**:

- 縦に崩れた OCR 出力に対応するパースロジックの実装
- 曜日を基準にしたレコード抽出アルゴリズム
- 様々な時刻形式（9.30、9:30、9 時 30 分など）に対応

#### 2. Excel 抽出機能の実装（`src/excel_extractor.py`）

**実装内容**:

- pandas/openpyxl を使用した Excel ファイル読み込み
- 列の自動検出機能
- .xlsx、.xls 形式に対応
- 日付、出勤時刻、退勤時刻、休憩時間の抽出

**主な機能**:

- `extract_from_excel()`: Excel ファイルからの勤怠データ抽出
- `detect_columns()`: 列の自動検出（日付、時刻などの列を自動識別）

#### 3. データ正規化機能の実装（`src/utils.py`）

**実装内容**:

- 日付形式の正規化（YYYY-MM-DD 形式）
- 時刻形式の正規化（HH:MM 形式）
- 様々な日付・時刻形式に対応
  - 日付: 2024/01/01、2024 年 1 月 1 日、1/1 など
  - 時刻: HH:MM、HH.MM、HH 時 MM 分など
- 勤務時間計算機能

**主な機能**:

- `normalize_date()`: 日付形式の正規化
- `normalize_time()`: 時刻形式の正規化
- `calculate_work_hours()`: 勤務時間の計算

#### 4. データ検証機能の実装（`src/data_validator.py`）

**実装内容**:

- 抽出データの妥当性チェック
- 欠損データの検出と警告
- 異常値の検出（例：24 時間を超える勤務時間など）

**主な機能**:

- `validate_records()`: レコードの検証
- エラーレポートの生成

---

### フェーズ 2: 自動入力機能の実装

#### 5. レコル自動入力機能の実装（`src/recoru_client.py`）

**実装内容**:

- Selenium を使用したレコルへの自動ログイン
- 勤怠データの自動入力
- エラーハンドリングとリトライ機能

**主な機能**:

- `login()`: レコルへの自動ログイン
- `input_attendance()`: 単一レコードの入力
- `input_multiple_attendance()`: 複数レコードの一括入力
- `_setup_driver()`: Selenium ドライバーのセットアップ
- ヘッドレスモード対応

**技術的詳細**:

- ChromeDriver の自動管理（webdriver-manager 使用）
- ボット検出回避のためのユーザーエージェント設定
- 適切な待機時間の設定（WebDriverWait 使用）

---

### フェーズ 3: UI 実装

#### 6. Streamlit GUI 実装（`app.py`）

**実装内容**:

- Streamlit を使用した Web ベースの GUI
- ファイル選択機能
- データプレビュー機能
- 実行ログ表示
- デバッグ情報の表示

**主な機能**:

- タブベースの UI（ファイル選択、データ確認、検証結果、実行）
- リアルタイムの処理状況表示
- デバッグモードによる OCR テキストの表示
- PDF の各ページのテキスト抽出結果表示

**修正ポイント**:

- デバッグ情報の追加（OCR 抽出テキスト、PDF ページ情報、Excel 列情報）
- エラーハンドリングの改善
- ユーザーフレンドリーなエラーメッセージ

#### 7. コマンドライン版の実装（`main.py`）

**実装内容**:

- コマンドライン引数によるファイル指定
- 検証のみ実行オプション（`--validate-only`）
- ヘッドレスモードオプション（`--headless`）
- 詳細なログ出力

**主な機能**:

- `extract_from_file()`: ファイルタイプに応じた抽出処理
- 処理結果の詳細表示
- エラーハンドリング

---

### フェーズ 4: 改善・最適化

#### 8. PDF 処理の改善

**修正内容**:

- Poppler パスの設定方法の改善
  - `config.json`の`ocr.poppler_path`で指定可能
  - 環境変数`POPPLER_PATH`でも指定可能
- エラーメッセージの改善（Poppler 未設定時の具体的な対処法を提示）
- PDF の各ページを個別に処理

#### 9. 画像前処理の改善

**修正内容**:

- 傾き補正機能の追加（`detect_skew_angle()`, `deskew_image()`）
- より高度なノイズ除去アルゴリズムの適用
- コントラスト調整の最適化

#### 10. データパースロジックの改善

**修正内容**:

- 縦に崩れた OCR 出力に対応
- 曜日を基準にしたレコード抽出アルゴリズムの実装
- 様々な時刻形式への対応強化
- ノイズを含むテキストの処理改善（例：「27)」「31・い」など）

#### 11. 設定ファイルの改善（`config.json`）

**修正内容**:

- OCR 設定の追加（`ocr.poppler_path`）
- レコル認証情報の設定
- 環境変数による設定の上書き対応

#### 12. ログ機能の改善

**修正内容**:

- 詳細なログ出力（処理の各段階でのログ）
- ファイルログとコンソールログの両方に対応
- ログレベルの適切な設定

---

## 技術スタック

### AI・機械学習関連

| 技術          | バージョン | 用途                                                 |
| ------------- | ---------- | ---------------------------------------------------- |
| EasyOCR       | >=1.7.0    | ディープラーニングベースの OCR（デフォルト）         |
| pytesseract   | >=0.3.10   | Tesseract OCR の Python ラッパー（フォールバック）   |
| opencv-python | >=4.8.0    | 画像前処理（傾き補正、ノイズ除去、コントラスト調整） |
| Pillow        | >=10.0.0   | 画像の読み込み・変換                                 |

### データ処理関連

| 技術     | バージョン | 用途                                 |
| -------- | ---------- | ------------------------------------ |
| pandas   | >=2.0.0    | Excel ファイルの読み込み・データ処理 |
| openpyxl | >=3.1.0    | Excel ファイルの詳細な操作           |
| xlrd     | >=2.0.1    | 古い Excel 形式（.xls）の読み込み    |

### ブラウザ自動化関連

| 技術              | バージョン | 用途                                         |
| ----------------- | ---------- | -------------------------------------------- |
| selenium          | >=4.15.0   | Web ブラウザの自動操作（レコルへの自動入力） |
| webdriver-manager | >=4.0.0    | ChromeDriver の自動管理                      |

### GUI 関連

| 技術      | バージョン | 用途                            |
| --------- | ---------- | ------------------------------- |
| streamlit | >=1.28.0   | Web ベースの GUI フレームワーク |

### その他

| 技術            | バージョン | 用途             |
| --------------- | ---------- | ---------------- |
| pdf2image       | >=1.16.0   | PDF を画像に変換 |
| python-dateutil | >=2.8.2    | 日付処理         |
| pytz            | >=2023.3   | タイムゾーン処理 |

### システム要件

- **Python**: 3.8 以上
- **Tesseract OCR**: システムレベルでインストールが必要
- **Poppler**: PDF 処理に必要（システムレベルでインストール、または PATH 設定）

---

## 実装の特徴

### 1. 柔軟な OCR エンジン選択

- デフォルトで EasyOCR を使用（高い認識精度）
- EasyOCR が使用できない場合、自動的に Tesseract OCR にフォールバック
- ユーザーが明示的に選択することも可能

### 2. 高度な画像前処理

- 傾き補正による画像の補正
- ノイズ除去による画像品質の向上
- コントラスト調整による文字の可読性向上
- 二値化処理によるテキストと背景の分離

### 3. 堅牢なデータパース

- 様々な日付・時刻形式に対応
- 縦に崩れた OCR 出力にも対応
- ノイズを含むテキストの処理
- 曜日を基準にしたレコード抽出

### 4. 包括的なエラーハンドリング

- 各処理段階でのエラーハンドリング
- 分かりやすいエラーメッセージ
- デバッグ情報の提供

### 5. ユーザーフレンドリーな UI

- Streamlit による直感的な Web UI
- リアルタイムの処理状況表示
- デバッグ情報の表示
- データのプレビューと編集機能

### 6. 柔軟な設定

- 設定ファイル（`config.json`）による設定
- 環境変数による設定の上書き
- コマンドライン引数による実行時設定

---

## 今後の改善案

1. **AI 技術の改善**

   - GPU 対応の有効化（認識速度の向上）
   - より高度な画像前処理アルゴリズムの実装
   - カスタムモデルの学習（特定の勤怠表フォーマットに最適化）

2. **機能追加**

   - 複数ファイルの一括処理
   - データの履歴管理
   - 他の勤怠システムへの対応
   - クラウドストレージ連携

3. **パフォーマンス改善**
   - 並列処理による処理速度の向上
   - キャッシュ機能の実装
   - メモリ使用量の最適化

---

## 参考リンク

- **EasyOCR**: https://github.com/JaidedAI/EasyOCR
- **Tesseract OCR**: https://github.com/tesseract-ocr/tesseract
- **OpenCV**: https://opencv.org/
- **Streamlit**: https://streamlit.io/
- **Selenium**: https://www.selenium.dev/
- **レコル**: https://app.recoru.in/ap/home/

---

**最終更新日**: 2024 年（プロジェクト作成時点）
