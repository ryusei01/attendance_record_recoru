# 勤怠記録自動入力アプリ 使い方ガイド

## 目次

1. [初回セットアップ](#初回セットアップ)
2. [GUI 版の使い方](#gui版の使い方)
3. [コマンドライン版の使い方](#コマンドライン版の使い方)
4. [ファイル形式とデータ形式](#ファイル形式とデータ形式)
5. [よくある質問](#よくある質問)
6. [トラブルシューティング](#トラブルシューティング)

---

## 初回セットアップ

### 1. 必要なソフトウェアのインストール

#### Tesseract OCR

##### Windows

1. https://github.com/UB-Mannheim/tesseract/wiki からインストーラーをダウンロード
2. インストーラーを実行してインストール
3. **デフォルトのインストール場所**: `C:\Program Files\Tesseract-OCR`
4. **PATH 環境変数の設定**:
   - インストーラーで「Add to PATH」オプションを選択した場合は自動設定されます
   - 手動で設定する場合:
     1. 「システムのプロパティ」→「環境変数」を開く
     2. 「システム環境変数」の「Path」を選択して「編集」
     3. 「新規」をクリックして以下を追加:
        ```
        C:\Program Files\Tesseract-OCR
        ```
     4. 「OK」をクリックして保存
5. **動作確認**:
   ```bash
   tesseract --version
   ```

##### macOS

```bash
brew install tesseract
```

- **インストール場所**: `/usr/local/bin/tesseract`（Homebrew のデフォルト）
- PATH は自動的に設定されます

##### Linux

```bash
sudo apt-get install tesseract-ocr
```

- **インストール場所**: `/usr/bin/tesseract`
- PATH は自動的に設定されます

#### Poppler（PDF 処理用）

##### Windows

1. https://github.com/oschwartz10612/poppler-windows/releases/ から最新版をダウンロード
2. ZIP ファイルを解凍（例: `C:\poppler`）
3. **PATH 環境変数の設定**:
   1. 「システムのプロパティ」→「環境変数」を開く
   2. 「システム環境変数」の「Path」を選択して「編集」
   3. 「新規」をクリックして以下を追加（解凍したフォルダの`bin`フォルダ）:
      ```
      C:\poppler\Library\bin
      ```
      または
      ```
      C:\poppler\poppler-XX.XX.X\Library\bin
      ```
      （XX.XX.X はバージョン番号）
   4. 「OK」をクリックして保存
4. **動作確認**:
   ```bash
   pdftoppm -h
   ```

##### macOS

```bash
brew install poppler
```

- **インストール場所**: `/usr/local/bin/`（Homebrew のデフォルト）
- PATH は自動的に設定されます

##### Linux

```bash
sudo apt-get install poppler-utils
```

- **インストール場所**: `/usr/bin/`
- PATH は自動的に設定されます

#### Python 3.8 以上

- https://www.python.org/downloads/ からダウンロード
- **Windows の場合**: インストール時に「Add Python to PATH」にチェックを入れることを推奨
- **インストール場所の確認**:
  ```bash
  python --version
  which python  # macOS/Linux
  where python  # Windows
  ```

### 1.1 インストール後の確認

すべてのソフトウェアが正しくインストールされ、PATH に追加されているか確認してください：

#### Windows（PowerShell またはコマンドプロンプト）

```bash
# Tesseract OCRの確認
tesseract --version

# Popplerの確認
pdftoppm -h

# Pythonの確認
python --version
```

#### macOS/Linux（ターミナル）

```bash
# Tesseract OCRの確認
tesseract --version

# Popplerの確認
pdftoppm -h

# Pythonの確認
python3 --version
```

**注意**: 環境変数を変更した後は、**ターミナル/コマンドプロンプトを再起動**する必要があります。

### 2. 依存関係のインストール

プロジェクトのルートディレクトリで以下を実行：

```bash
pip install -r requirements.txt
```

### 3. 設定ファイルの作成

`config.json.example`をコピーして`config.json`を作成：

```bash
cp config.json.example config.json
```

`config.json`を編集して、レコルの認証情報を入力：

```json
{
  "ocr": {
    "poppler_path": "C:\\poppler\\Library\\bin"
  },
  "recoru": {
    "contract_id": "あなたの契約ID",
    "login_id": "あなたのログインID",
    "password": "あなたのパスワード",
    "base_url": "https://app.recoru.in/ap/menuAttendance/?ui=362&pp=1",
    "profile_path": "H:\\document\\program\\project\\attendance_record_recoru\\chrome_profile",
    "login_retry_count": 3,
    "login_retry_interval": 5
  }
}
```

**設定項目の説明**:

- `ocr.poppler_path`: Poppler の bin ディレクトリパス（PDF 処理時に使用、PATH に通していない場合のみ必要）
- `recoru.base_url`: Recoru の勤怠入力ページ URL（デフォルト値が設定済み）
- `recoru.profile_path`: Chrome のプロファイルパス（ログイン状態を保持する場合に使用）
- `recoru.login_retry_count`: ログイン失敗時のリトライ回数（デフォルト: 3 回）
- `recoru.login_retry_interval`: ログインリトライ間隔（秒、デフォルト: 5 秒）

**重要**: `config.json`には機密情報が含まれるため、Git にコミットされないよう`.gitignore`に含まれています。

---

## GUI 版の使い方

### 起動方法

```bash
streamlit run app.py
```

ブラウザが自動的に開き、アプリケーションが起動します。開かない場合は、表示された URL（通常は`http://localhost:8501`）をブラウザで開いてください。

### 操作手順

#### ステップ 1: ファイル選択

1. **「📤 ファイル選択」タブ**を開く
2. **「勤怠ファイルをアップロード」**をクリック
3. 以下のいずれかのファイル形式を選択：
   - 画像ファイル: JPEG、PNG
   - PDF ファイル: PDF
   - Excel ファイル: .xlsx、.xls
4. **「データを抽出」ボタン**をクリック
5. 抽出が完了すると、レコード数が表示されます

#### ステップ 2: データ確認

1. **「📊 データ確認」タブ**を開く
2. 抽出されたデータが表形式で表示されます
3. 各レコードには以下の情報が含まれます：
   - `date`: 日付（DD 形式）
   - `start_time`: 出勤時刻（HH:MM 形式）
   - `end_time`: 退勤時刻（HH:MM 形式）
   - `break_time`: 休憩時間（HH:MM 形式）
   - `work_hours`: 勤務時間（時間単位）

#### ステップ 3: 検証結果の確認

1. **「✅ 検証結果」タブ**を開く
2. 以下の情報が表示されます：
   - **総レコード数**: 抽出された全レコード数
   - **有効レコード**: 検証を通過したレコード数
   - **無効レコード**: エラーがあるレコード数
3. 無効なレコードがある場合、エラー内容が表示されます
4. エラーを確認し、必要に応じて元のファイルを修正してください

#### ステップ 4: レコルへの自動入力

1. **「🚀 実行」タブ**を開く
2. サイドバーで認証情報を確認・入力：
   - 契約 ID
   - ログイン ID
   - パスワード
   - Recoru 勤怠入力ページ URL（デフォルト値が設定済み）
   - Chrome プロファイルパス（ログイン状態を保持する場合）
   - ヘッドレスモード（チェックボックス）
3. **「自動入力を開始」ボタン**をクリック
4. 処理が進行中は、プログレスバーとログが表示されます
5. 完了後、成功・失敗の件数が表示されます
6. **正常に完了した場合、ブラウザは開いたままになります**（手動で確認可能）

### サイドバーの設定

- **設定ファイルパス**: 設定ファイルのパスを指定（デフォルト: `config.json`）
- **契約 ID**: レコルの契約 ID
- **ログイン ID**: レコルのログイン ID
- **パスワード**: レコルのパスワード
- **Recoru 勤怠入力ページ URL**: Recoru の勤怠入力ページ URL（デフォルト値が設定済み）
- **Chrome プロファイルパス**: Chrome のプロファイルパス（ログイン状態を保持する場合に使用）
- **ヘッドレスモード**: チェックすると、ブラウザを表示せずに実行（バックグラウンド処理）

---

## コマンドライン版の使い方

### 基本的な使い方

```bash
python main.py --file <ファイルパス>
```

### 使用例

#### Excel ファイルから抽出して入力

```bash
python main.py --file attendance_2024_01.xlsx
```

#### 画像ファイルから抽出して入力

```bash
python main.py --file attendance_table.jpg
```

#### PDF ファイルから抽出して入力

```bash
python main.py --file attendance_report.pdf
```

#### 検証のみ実行（レコルへの入力は行わない）

```bash
python main.py --file attendance.xlsx --validate-only
```

#### ヘッドレスモードで実行

```bash
python main.py --file attendance.xlsx --headless
```

#### Recoru の URL を指定

```bash
python main.py --file attendance.xlsx --url "https://app.recoru.in/ap/menuAttendance/?ui=362&pp=1"
```

#### Chrome プロファイルパスを指定

```bash
python main.py --file attendance.xlsx --profile "C:\\Users\\username\\AppData\\Local\\Google\\Chrome\\User Data"
```

#### カスタム設定ファイルを使用

```bash
python main.py --file attendance.xlsx --config my_config.json
```

### コマンドライン引数

| 引数              | 短縮形 | 説明                                            | 必須 |
| ----------------- | ------ | ----------------------------------------------- | ---- |
| `--file`          | `-f`   | 入力ファイル（画像または Excel）のパス          | ✅   |
| `--config`        | `-c`   | 設定ファイルのパス（デフォルト: `config.json`） | ❌   |
| `--validate-only` | -      | 検証のみ実行（レコルへの入力は行わない）        | ❌   |
| `--headless`      | -      | ヘッドレスモードで実行                          | ❌   |
| `--url`           | `-u`   | Recoru の勤怠入力ページ URL                     | ❌   |
| `--profile`       | `-p`   | Chrome のプロファイルパス                       | ❌   |

### 実行結果

コマンドライン版では、以下の情報が表示されます：

1. **データ抽出結果**

   - 抽出されたレコード数

2. **データ検証結果**

   - 総レコード数
   - 有効レコード数
   - 無効レコード数
   - 無効なレコードの詳細（エラーメッセージ）

3. **自動入力結果**
   - 総レコード数
   - 成功件数
   - 失敗件数
   - 失敗したレコードの詳細

**注意事項**:

- 正常に処理が完了した場合、ブラウザは開いたままになります（手動で確認可能）
- エラーが発生した場合、ブラウザは自動的に閉じられます
- 既に入力がある日付は自動的にスキップされます
- ログイン失敗時は自動的にリトライされます（デフォルト: 3 回、5 秒間隔）

### ログファイル

実行ログは`logs/app.log`に保存されます。エラーが発生した場合は、このファイルを確認してください。

---

## ファイル形式とデータ形式

### 対応ファイル形式

#### 画像ファイル

- **JPEG** (.jpg, .jpeg)
- **PNG** (.png)
- **PDF** (.pdf)

#### Excel ファイル

- **Excel 2007 以降** (.xlsx)
- **Excel 97-2003** (.xls)

### データ形式の要件

#### 画像ファイルの場合

画像内のテキストから以下の情報を抽出します：

- **日付**: 以下の形式に対応

  - `2024/01/01`
  - `2024-01-01`
  - `2024年1月1日`
  - `01/01/2024`

- **出勤時刻**: 以下の形式に対応

  - `09:00`
  - `9時00分`
  - `0900`

- **退勤時刻**: 出勤時刻と同じ形式

- **休憩時間**: 出勤時刻と同じ形式（オプション）

**推奨形式**:

```
2024年1月1日
出勤: 09:00
退勤: 18:00
休憩: 01:00
```

#### Excel ファイルの場合

Excel ファイルには以下の列が必要です：

| 列名の例                        | 説明     | 必須 |
| ------------------------------- | -------- | ---- |
| `日付`、`date`、`年月日`        | 日付     | ✅   |
| `出勤`、`開始`、`start`、`出社` | 出勤時刻 | ✅   |
| `退勤`、`終了`、`end`、`退社`   | 退勤時刻 | ✅   |
| `休憩`、`break`                 | 休憩時間 | ❌   |

**列名の自動検出**:
アプリケーションは列名から自動的に各項目を検出します。上記の例以外の列名でも、類似した名前であれば検出される可能性があります。

**データ例**:

| 日付       | 出勤  | 退勤  | 休憩  |
| ---------- | ----- | ----- | ----- |
| 2024-01-01 | 09:00 | 18:00 | 01:00 |
| 2024-01-02 | 09:30 | 18:30 | 01:00 |

---

## 主な機能と動作

### ログインリトライ機能

ログインに失敗した場合、自動的にリトライされます：

- デフォルト: 3 回までリトライ、5 秒間隔
- `config.json`の`login_retry_count`と`login_retry_interval`で変更可能
- すべてのリトライが失敗した場合、ブラウザは開いたままになります（手動で確認可能）

### 既存入力のスキップ機能

既に出勤時刻や退勤時刻が入力されている日付は、自動的にスキップされます：

- 既存の入力内容を上書きしません
- ログに「既に入力があるため、スキップしました」と表示されます
- スキップされたレコードは成功としてカウントされます

### ブラウザの動作

- **正常完了時**: ブラウザは開いたままになります（手動で確認可能）
- **エラー発生時**: ブラウザは自動的に閉じられます
- **ログイン失敗時**: ブラウザは開いたままになります（手動で確認可能）
- **「自動入力を開始」ボタン押下時**: 既存のブラウザがあれば閉じて、新しいブラウザで開始

### ページリロードの最適化

- 複数レコードの入力時、最初の 1 回だけページを読み込みます
- 以降のレコード入力時は、現在の URL が正しいか確認するだけです
- これにより処理速度が向上し、ページの状態も維持されます

### 出勤区分の設定

- すべてのレコードに対して、出勤区分は常に「1」（出勤）が選択されます
- レコードの状態（status）に関係なく、出勤として入力されます

## よくある質問

### Q1: OCR の認識精度が低いです

**A**: 以下の対策を試してください：

1. **画像の品質を向上させる**

   - 解像度を 300dpi 以上にする
   - コントラストを調整する
   - ノイズを除去する

2. **画像の向きを確認する**

   - 画像が傾いていないか確認
   - 必要に応じて回転・補正

3. **文字の種類を確認する**
   - 印刷されたテキストの方が認識精度が高い
   - 手書き文字は認識精度が低くなる可能性があります

### Q2: Excel ファイルの列が認識されません

**A**: 以下の方法を試してください：

1. **列名を確認する**

   - 列名に「日付」「出勤」「退勤」などのキーワードが含まれているか確認
   - 列名を変更して再試行

2. **データ形式を確認する**

   - 日付列が日付形式になっているか確認
   - 時刻列が時刻形式になっているか確認

3. **手動で列を指定する**
   - 現在の実装では自動検出のみですが、将来的に手動指定機能を追加予定

### Q3: レコルへのログインに失敗します

**A**: 以下の点を確認してください：

1. **認証情報の確認**

   - 契約 ID、ログイン ID、パスワードが正しいか確認
   - `config.json`の内容を確認

2. **ネットワーク接続の確認**

   - インターネット接続を確認
   - レコルのサイトにアクセスできるか確認

3. **レコルの UI 変更**

   - レコルの UI が変更されている可能性があります
   - その場合は、`src/recoru_client.py`のセレクターを調整する必要があります

4. **ログインリトライ機能**
   - ログイン失敗時は自動的にリトライされます（デフォルト: 3 回、5 秒間隔）
   - すべてのリトライが失敗した場合、ブラウザは開いたままになります（手動で確認可能）
   - `config.json`の`login_retry_count`と`login_retry_interval`で調整可能

### Q4: 処理が途中で止まります

**A**: 以下の対策を試してください：

1. **ログファイルを確認**

   - `logs/app.log`を確認してエラー内容を確認

2. **タイムアウト設定の調整**

   - ネットワークが遅い場合、タイムアウト時間を延長する必要があるかもしれません

3. **ヘッドレスモードの使用**
   - GUI 版でヘッドレスモードを有効にする
   - コマンドライン版で`--headless`オプションを使用

### Q5: 複数のファイルを一括処理できますか？

**A**: 現在のバージョンでは、1 ファイルずつの処理のみ対応しています。複数ファイルを処理する場合は、スクリプトを作成するか、各ファイルを個別に処理してください。

将来的に一括処理機能を追加予定です。

### Q6: インストールしたソフトウェアの配置場所は指定できますか？

**A**: はい、配置場所は指定できますが、**PATH 環境変数に追加する必要があります**。

#### Windows の場合

- **Tesseract OCR**:

  - デフォルト: `C:\Program Files\Tesseract-OCR`
  - カスタム場所にインストールした場合、その場所の`bin`フォルダを PATH に追加
  - 例: `D:\MyTools\Tesseract-OCR`にインストールした場合、PATH に`D:\MyTools\Tesseract-OCR`を追加

- **Poppler**:
  - 任意の場所に解凍可能（例: `C:\poppler`、`D:\tools\poppler`）
  - 解凍したフォルダの`Library\bin`フォルダを PATH に追加
  - 例: `C:\poppler\Library\bin`を PATH に追加

#### macOS/Linux の場合

- **Homebrew でインストールした場合**: 通常は`/usr/local/bin`に配置され、自動的に PATH に追加されます
- **手動でインストールした場合**: インストールした場所の`bin`フォルダを PATH に追加する必要があります

**重要**: 環境変数を変更した後は、**必ずターミナル/コマンドプロンプトを再起動**してください。

---

## トラブルシューティング

### エラー: "Tesseract OCR が見つかりません"

**解決方法**:

1. **Tesseract OCR がインストールされているか確認**

   ```bash
   tesseract --version
   ```

   エラーが出る場合は、インストールされていません。

2. **PATH 環境変数の確認と設定**

   **Windows の場合**:

   - インストール場所の確認: 通常は`C:\Program Files\Tesseract-OCR`
   - PATH 環境変数に以下が含まれているか確認:
     ```
     C:\Program Files\Tesseract-OCR
     ```
   - 含まれていない場合:
     1. 「システムのプロパティ」→「環境変数」を開く
     2. 「システム環境変数」の「Path」を選択して「編集」
     3. 「新規」をクリックして`C:\Program Files\Tesseract-OCR`を追加
     4. 「OK」をクリックして保存
     5. **コマンドプロンプト/PowerShell を再起動**

   **macOS/Linux の場合**:

   - インストール場所の確認:
     ```bash
     which tesseract
     ```
   - 通常は`/usr/local/bin/tesseract`（macOS）または`/usr/bin/tesseract`（Linux）
   - PATH に含まれていない場合、シェルの設定ファイル（`.bashrc`、`.zshrc`など）に追加

3. **Python コードでパスを直接指定する方法**（一時的な解決策）

   `src/ocr_extractor.py`を編集して、Tesseract のパスを直接指定:

   ```python
   import pytesseract
   # Windowsの場合
   pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
   ```

   ただし、この方法は推奨されません。PATH 環境変数を正しく設定することをお勧めします。

### エラー: "EasyOCR の初期化に失敗しました"

**解決方法**:

1. EasyOCR が正しくインストールされているか確認: `pip install easyocr`
2. インターネット接続を確認（初回起動時にモデルをダウンロードします）
3. 十分なディスク容量があるか確認

### エラー: "PDF 処理には pdf2image が必要です"

**解決方法**:

1. **pdf2image のインストール**

   ```bash
   pip install pdf2image
   ```

2. **Poppler がインストールされているか確認**

   ```bash
   pdftoppm -h
   ```

   エラーが出る場合は、Poppler がインストールされていないか、PATH に追加されていません。

3. **PATH 環境変数の確認と設定**

   **Windows の場合**:

   - Poppler のインストール場所を確認（例: `C:\poppler\Library\bin`）
   - PATH 環境変数に以下が含まれているか確認:
     ```
     C:\poppler\Library\bin
     ```
   - 含まれていない場合、上記の「Poppler（PDF 処理用）」セクションの手順に従って PATH を設定
   - **コマンドプロンプト/PowerShell を再起動**

   **macOS/Linux の場合**:

   - インストール場所の確認:
     ```bash
     which pdftoppm
     ```
   - 通常は`/usr/local/bin/pdftoppm`（macOS）または`/usr/bin/pdftoppm`（Linux）

### エラー: "ChromeDriver が見つかりません"

**解決方法**:

- `webdriver-manager`が自動的に ChromeDriver をダウンロードします
- インターネット接続を確認してください
- Chrome ブラウザがインストールされているか確認してください

### エラー: "設定ファイルが見つかりません"

**解決方法**:

1. `config.json`ファイルがプロジェクトのルートディレクトリに存在するか確認
2. `config.json.example`をコピーして`config.json`を作成
3. コマンドライン版の場合、`--config`オプションでパスを指定

### エラー: "画像を読み込めませんでした"

**解決方法**:

1. ファイルパスが正しいか確認
2. ファイルが存在するか確認
3. ファイル形式が対応しているか確認（JPEG、PNG、PDF）

### エラー: "Excel ファイルの読み込みに失敗しました"

**解決方法**:

1. ファイルが開かれていないか確認（他のアプリケーションで閉じる）
2. ファイルが破損していないか確認
3. ファイル形式が対応しているか確認（.xlsx、.xls）

---

## サポート

問題が解決しない場合は、以下を確認してください：

1. **ログファイル**: `logs/app.log`を確認
2. **要件定義**: `要件定義.md`を参照
3. **README**: `README.md`を参照

---

## 更新履歴

- **v1.0.0** (2024): 初回リリース
  - 画像ファイルからの OCR 読み取り機能
  - Excel ファイルからのデータ読み取り機能
  - レコルへの自動入力機能
  - GUI 版とコマンドライン版の両方を提供
